---
title: "Relatório de análise dos preços ao produtor"
author: "João Pedro Magro"
date: "Última atualização no dia `r format(Sys.time(), '%d de %B de %Y')` ás `r format(Sys.time(), '%H:%M')`"
output: 
   html_document:
   number_sections: true
   toc: true
---

```{r SETUP, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE
                      ,results = 'show'
                      ,error=FALSE
                      ,warning=FALSE
                      ,message=FALSE)
```

```{r BIBLIOTECAS, echo=FALSE}
#'*Coleta e manipulação de dados*
library(tidyverse)
library(lubridate)
library(plyr)
library(kableExtra)

#'*Gráficos*

library(ggplot2)
library(GGally)
library(ggpubr)
library(RColorBrewer)
library(plotly)
library(patchwork)

#'*Análises*
library(car)
library(tseries)

```

```{r DADOS, echo=FALSE}
BD_COMP_PAP_PTD_ST_DEFLA_ANA_W_IPCA_IGPM <- readRDS("~/R_CORE/GitHub/IAIABR/PAP_PTD/PAP_PTD_DADOS/BD_COMP_PAP_PTD_ST_DEFLA_ANA_W_IPCA_IGPM.rds")

BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM<-pivot_longer(BD_COMP_PAP_PTD_ST_DEFLA_ANA_W_IPCA_IGPM,
                                             names_to = "VARIAVEIS",
                                             values_to = "VALORES",
                                             cols = c(3:11))

PROX<-tibble(
  Produtos=c("Arroz (em casca)","Banana (cacho)","Batata-inglesa","Café (em grão) Total","Cebola","Feijão (em grão)", "Laranja","Mandioca","Milho (em grão)","Soja (em grão)","Tomate","Trigo (em grão)"
  ,"Carcaça bovino","Leite","Carcaça suíno","Carcaça frango","Ovos de galinha"),
  Origem=c(rep("Vegetal",12),rep("Animal",5))
)

BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM<-left_join(BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM,PROX,by=c("PRODUTO"="Produtos"))

VARS <- colnames(BD_COMP_PAP_PTD_ST_DEFLA_ANA_W_IPCA_IGPM)

rm(PROX)
```



### Valor total da produção {.tabset}
***

#### Gráficos {.tabset}

##### Toda série {.tabset}

###### Série histórica do valor total da produção - Corrigidos pelo IPCA
***

```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[3]&ANO>=2007&ANO<=2019) |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

DF_GRAF_1<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[3]&ANO>=2007&ANO<=2013) |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

DF_GRAF_2<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[3]&ANO>=2013&ANO<=2019) |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=10)

# PLOT 1 ----
SH_PLT<-ggplot(DF_GRAF, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous("Bilhões de reais",
                      limits = c(0,max(DF_GRAF$VALORES)+1),
                      label = function(VALORES){return(paste("R$",VALORES))},
                      breaks = breaks)+
   theme_bw()+
   ylab("Milhões de reais")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))


ggplotly(SH_PLT)
```


##### Série dividida {.tabset}

```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF_1<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[3]&ANO>=2007&ANO<=2013&
             !is.na(VALORES)&PRODUTO != "Carcaça suíno") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

DF_GRAF_2<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[3]&
             ANO>=2013&ANO<=2019&
             !is.na(VALORES)) |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=10)

# PLOT 1 ----
SH_PLT_1<-ggplot(DF_GRAF_1, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous("Bilhões de reais",
                      limits = c(0,max(DF_GRAF$VALORES)+1),
                      label = function(VALORES){return(paste("R$",VALORES))},
                      breaks = breaks)+
   theme_bw()+
   ylab("Milhões de reais")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

# PLOT 1 ----
SH_PLT_2<-ggplot(DF_GRAF_2, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous("Bilhões de reais",
                      limits = c(0,max(DF_GRAF$VALORES)+1),
                      label = function(VALORES){return(paste("R$",VALORES))},
                      breaks = breaks)+
   theme_bw()+
   ylab("Milhões de reais")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

```

###### Série histórica do valor total da produção (2007 - 2013) - Corrigidos pelo IPCA {.tabset}
***

```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_1)
```


###### Série histórica do valor total da produção (2013 - 2019) - Corrigidos pelo IPCA {.tabset}
***

```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_2)
```


#### Tabelas {.tabset}

##### Toda série {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear do valor total da produção - Corrigidos pelo IPCA
***

```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                     if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                             if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                     if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
   })

models_1 <- DF_GRAF |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
  kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF$VALORES,DF_GRAF$PRODUTO),same_lim = FALSE))
```

##### Série dividida {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear do valor total da produção (2007 - 2013) - Corrigidos pelo IPCA {.tabset}
***

```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_1 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_1 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_1$VALORES,DF_GRAF_1$PRODUTO),same_lim = FALSE))
```

###### Estatísticas descritivas e Modelos de regressão linear do valor total da produção (2013 - 2019) - Corrigidos pelo IPCA {.tabset}
***

```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_2 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_2 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_2$VALORES,DF_GRAF_2$PRODUTO),same_lim = FALSE))
```


<br>

***

<br>
<br>

### Preço ao produtor {.tabset}
***

#### Gráficos {.tabset}

##### Toda série {.tabset}

###### Série histórica do preço ao produtor - Corrigidos pelo IPCA
***

```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[4]&ANO>=2007&ANO<=2019) |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=500)

# PLOT 1 ----
SH_PLT<-ggplot(DF_GRAF, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous("R$/Tonelada",
                      limits = c(0,max(DF_GRAF$VALORES)+1),
                      label = function(VALORES){return(paste("R$",VALORES))},
                      breaks = breaks)+
   theme_bw()+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

ggplotly(SH_PLT)
```


##### Série dividida {.tabset}

```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF_1<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[3]&ANO>=2007&ANO<=2013&
             !is.na(VALORES)&PRODUTO !="Carcaça suíno") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

DF_GRAF_2<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[3]&
             ANO>=2013&ANO<=2019&
             !is.na(VALORES)) |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=500)

# PLOT 1 ----
SH_PLT_1<-ggplot(DF_GRAF_1, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous("R$/Tonelada",
                      limits = c(0,max(DF_GRAF$VALORES)+1),
                      label = function(VALORES){return(paste("R$",VALORES))},
                      breaks = breaks)+
   theme_bw()+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

# PLOT 1 ----
SH_PLT_2<-ggplot(DF_GRAF_2, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous("R$/Tonelada",
                      limits = c(0,max(DF_GRAF$VALORES)+1),
                      label = function(VALORES){return(paste("R$",VALORES))},
                      breaks = breaks)+
   theme_bw()+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

```

###### Série histórica do preço ao produtor (2007 - 2013) - Corrigidos pelo IPCA {.tabset}
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_1)
```


###### Série histórica do preço ao produtor (2013 - 2019) - Corrigidos pelo IPCA {.tabset}
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_2)
```


#### Tabelas {.tabset}

##### Toda série {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear do preço ao produtor - Corrigidos pelo IPCA
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF$VALORES,DF_GRAF$PRODUTO),same_lim = FALSE))
```

##### Série dividida {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear do preço ao produtor (2007 - 2013) - Corrigidos pelo IPCA {.tabset}
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_1 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_1 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_1$VALORES,DF_GRAF_1$PRODUTO),same_lim = FALSE))
```

###### Estatísticas descritivas e Modelos de regressão linear do preço ao produtor (2013 - 2019) - Corrigidos pelo IPCA {.tabset}
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_2 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_2 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_2$VALORES,DF_GRAF_2$PRODUTO),same_lim = FALSE))
```

<br>

***

<br>
<br>

### Quantidade total produzida {.tabset}
***

#### Gráficos {.tabset}

##### Toda série {.tabset}

###### Série histórica da quantidade total produzida
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[7]&ANO>=2007&ANO<=2019) |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=10)

# PLOT 1 ----
SH_PLT<-ggplot(DF_GRAF, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Milhões de toneladas")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

ggplotly(SH_PLT)
```


##### Série dividida {.tabset}

```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF_1<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[7]&ANO>=2007&ANO<=2013&
             !is.na(VALORES)&PRODUTO !="Carcaça suíno") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

DF_GRAF_2<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[7]&
             ANO>=2013&ANO<=2019&
             !is.na(VALORES)) |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=10)

# PLOT 1 ----
SH_PLT_1<-ggplot(DF_GRAF_1, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Milhões de toneladas")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))
# PLOT 1 ----
SH_PLT_2<-ggplot(DF_GRAF_2, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Milhões de toneladas")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

```

###### Série histórica da quantidade total produzida (2007 - 2013) {.tabset}
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_1)
```


###### Série histórica da quantidade total produzida (2013 - 2019) {.tabset}
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_2)
```


#### Tabelas {.tabset}

##### Toda série {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear da quantidade total produzida
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF$VALORES,DF_GRAF$PRODUTO),same_lim = FALSE))
```

##### Série dividida {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear da quantidade total produzida (2007 - 2013) {.tabset}
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_1 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_1 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_1$VALORES,DF_GRAF_1$PRODUTO),same_lim = FALSE))
```

###### Estatísticas descritivas e Modelos de regressão linear da quantidade total produzida (2013 - 2019) {.tabset}
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_2 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_2 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_2$VALORES,DF_GRAF_2$PRODUTO),same_lim = FALSE))
```

<br>

***

<br>
<br>

### Produtividade {.tabset}
***

#### Gráficos {.tabset}

##### Toda série {.tabset}

###### Série histórica da produtividade
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[9]&ANO>=2007&ANO<=2019&PRODUTO !="Carcaça suíno"&PRODUTO !="Carcaça bovino"&PRODUTO !="Carcaça frango") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=10)

# PLOT 1 ----
SH_PLT<-ggplot(DF_GRAF, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Toneladas/ha")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

ggplotly(SH_PLT)
```


##### Série dividida {.tabset}

```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF_1<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[9]&ANO>=2007&ANO<=2013&
             !is.na(VALORES)&PRODUTO !="Carcaça suíno"&PRODUTO !="Carcaça bovino"&PRODUTO !="Carcaça frango") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

DF_GRAF_2<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[9]&
             ANO>=2013&ANO<=2019&
             !is.na(VALORES)&PRODUTO !="Carcaça suíno"&PRODUTO !="Carcaça bovino"&PRODUTO !="Carcaça frango") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=10)

# PLOT 1 ----
SH_PLT_1<-ggplot(DF_GRAF_1, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Toneladas/ha")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))
# PLOT 1 ----
SH_PLT_2<-ggplot(DF_GRAF_2, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO)) +
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Toneladas/ha")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

```

###### Série histórica da produtividade (2007 - 2013) {.tabset}
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_1)
```


###### Série histórica da produtividade (2013 - 2019) {.tabset}
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_2)
```


#### Tabelas {.tabset}

##### Toda série {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear da produtividade
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF$VALORES,DF_GRAF$PRODUTO),same_lim = FALSE))
```

##### Série dividida {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear da produtividade (2007 - 2013) {.tabset}
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_1 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_1 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_1$VALORES,DF_GRAF_1$PRODUTO),same_lim = FALSE))
```

###### Estatísticas descritivas e Modelos de regressão linear da produtividade (2013 - 2019) {.tabset}
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_2 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_2 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_2$VALORES,DF_GRAF_2$PRODUTO),same_lim = FALSE))
```

<br>

***

<br>
<br>

### Área destinada ao cultivo {.tabset}
***

#### Gráficos {.tabset}

##### Toda série {.tabset}

###### Série histórica da área destinada ao cultivo
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[8]&ANO>=2007&ANO<=2019&PRODUTO !="Carcaça suíno"&PRODUTO !="Carcaça bovino"&PRODUTO !="Carcaça frango"&PRODUTO !="Ovos de galinha"&PRODUTO !="Leite") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

breaks <- seq(0, max(DF_GRAF$VALORES,na.rm=T), by=10)

# PLOT 1 ----
SH_PLT<-ggplot(DF_GRAF, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO))+
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Milhões de hectares")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

ggplotly(SH_PLT)
```


##### Série dividida {.tabset}

```{r echo=FALSE, fig.width=11,fig.height=7}

DF_GRAF_1<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[8]&ANO>=2007&ANO<=2013&
             !is.na(VALORES)&PRODUTO !="Carcaça suíno"&PRODUTO !="Carcaça bovino"&PRODUTO !="Carcaça frango"&PRODUTO !="Ovos de galinha"&PRODUTO !="Leite") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

DF_GRAF_2<-BD_COMP_PAP_PTD_ST_DEFLA_ANA_L_IPCA_IGPM |>
   filter(VARIAVEIS%in%VARS[8]&
             ANO>=2013&ANO<=2019&
             !is.na(VALORES)&PRODUTO !="Carcaça suíno"&PRODUTO !="Carcaça bovino"&PRODUTO !="Carcaça frango"&PRODUTO !="Ovos de galinha"&PRODUTO !="Leite") |>
   mutate(DATE=as_date(paste(ANO,"1","1",sep = "-")))

# PLOT 1 ----
SH_PLT_1<-ggplot(DF_GRAF_1, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO))+
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Milhões de hectares")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))
# PLOT 1 ----
SH_PLT_2<-ggplot(DF_GRAF_2, aes(x=DATE, y=VALORES, group=PRODUTO, color=PRODUTO))+
   geom_line()+
   scale_x_date(date_labels="%Y",date_breaks  ="1 year")+
   scale_y_continuous(breaks = breaks )+
   theme_bw()+
   ylab("Milhões de hectares")+
   xlab("Ano")+
   guides(fill=guide_legend(title=NULL))+
   theme(legend.position="bottom",text = element_text(size = 13, face = "bold"),
         legend.title = element_blank(),
         axis.title.x = element_text(size = 15),
         axis.title.y = element_text(size = 20),
         axis.text.x = element_text(size = 10,angle = 35))

```

###### Série histórica da área destinada ao cultivo (2007 - 2013) {.tabset}
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_1)
```


###### Série histórica da área destinada ao cultivo (2013 - 2019) {.tabset}
***
   
```{r echo=FALSE, fig.width=11,fig.height=7}
ggplotly(SH_PLT_2)
```


#### Tabelas {.tabset}

##### Toda série {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear da área destinada ao cultivo
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF$VALORES,DF_GRAF$PRODUTO),same_lim = FALSE))
```

##### Série dividida {.tabset}

###### Estatísticas descritivas e Modelos de regressão linear da área destinada ao cultivo (2007 - 2013) {.tabset}
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_1 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_1 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_1$VALORES,DF_GRAF_1$PRODUTO),same_lim = FALSE))
```

###### Estatísticas descritivas e Modelos de regressão linear da área destinada ao cultivo (2013 - 2019) {.tabset}
***
   
```{r eval=TRUE, include=TRUE, echo = FALSE}
models <- ddply( DF_GRAF_2 , .(PRODUTO), function(x) {
   t <- lm(x, formula = VALORES ~ DATE)
   data.frame("Intercepto" = coefficients(t)[1], 
              Ano = coefficients(t)[2], 
              "PVAL" = summary(t)$coef[2,4],
              Significância = if_else(summary(t)$coef[2,4]<0.001,"0 ***",
                                      if_else(0.001<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.01,"0.001 **",
                                              if_else(0.01<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.05,"0.01 *",
                                                      if_else(0.05<=summary(t)$coef[2,4]&summary(t)$coef[2,4]<0.1,"0.1","1")))),
              "Durbin Watson - 5%" = if_else(durbinWatsonTest( model = t)[["p"]] < 0.05, "Resíduos possuem correlação", "Resíduos sem correlação")
   )
})

models_1 <- DF_GRAF_2 |>
   group_by(PRODUTO) |>
   dplyr::summarise(
      MÉDIA = mean(VALORES, na.rm = T),
      DESV.PAD = sd(VALORES, na.rm = T),
      Q5 = quantile(VALORES, 0.05, na.rm = T),
      Q95 = quantile(VALORES, 0.95, na.rm = T),
      "LAG" = kpss.test(VALORES, null="Level")[2][[1]],
      "KPSS - 5%" = if_else(kpss.test(VALORES, null="Level")[3][[1]] < 0.05, "Apresenta tendência", "Sem tendência")
   )

DESC <- left_join(models_1, models, by="PRODUTO")

DESC <- DESC |>
   mutate("Histograma"="", .after="Q95")

colNam <- colnames(DESC)

colNam <- c(colNam[1:12],"Durbin Watson - 5%")

colnames(DESC) <- colNam

DESC <- DESC |>
   mutate(MÉDIA = round(MÉDIA, 3),
          DESV.PAD = round(DESV.PAD, 3),
          Q5 = round(Q5, 3),
          Q95 = round(Q95, 3),
          Intercepto = round(Intercepto, 3),
          Ano = round(Ano, 6),
          PVAL = round(PVAL, 5))

kbl(DESC,table.attr = "style = \"color: black;\"", position = "c") |>
   kable_styling(font_size = 16, position = "c", full_width = TRUE) |>
   add_header_above(c(" ", "Descritivas" = 5, "Teste KPSS" = 2, "Modelo linear" = 5)) |>
   column_spec(6, image = spec_hist(split(DF_GRAF_2$VALORES,DF_GRAF_2$PRODUTO),same_lim = FALSE))
```

<br>

***

<br>
<br>
